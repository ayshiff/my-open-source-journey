"use strict";(self.webpackChunkthe_open_source_with_remi=self.webpackChunkthe_open_source_with_remi||[]).push([[303,364],{5317:function(e,t,n){n.r(t),n.d(t,{Highlight:function(){return m},assets:function(){return c},contentTitle:function(){return l},default:function(){return d},frontMatter:function(){return o},metadata:function(){return u},toc:function(){return p}});var a=n(3117),s=(n(7294),n(3905)),i=n(4996),r=n(6395);const o={id:"changesets80",title:"Changesets - Comment on released PRs and issues",sidebar_label:"8. Changesets - Comment on released PRs and issues"},l=void 0,u={unversionedId:"contributions/changesets80",id:"contributions/changesets80",title:"Changesets - Comment on released PRs and issues",description:"GitHub",source:"@site/docs/contributions/changesets#80.md",sourceDirName:"contributions",slug:"/contributions/changesets80",permalink:"/docs/contributions/changesets80",draft:!1,editUrl:"https://github.com/ayshiff/my-open-source-journey/docs/contributions/changesets#80.md",tags:[],version:"current",frontMatter:{id:"changesets80",title:"Changesets - Comment on released PRs and issues",sidebar_label:"8. Changesets - Comment on released PRs and issues"},sidebar:"docs",previous:{title:"7. ConsoleMe - AWS IAM policy linting",permalink:"/docs/contributions/consoleme9008"},next:{title:"9. Caramel - Pipe operator support",permalink:"/docs/contributions/caramel91"}},c={},m=e=>{let{children:t,color:n}=e;return(0,s.kt)("span",{style:{backgroundColor:n,borderRadius:"2px",color:"#fff",padding:"0.2rem",fontWeight:600}},t)},p=[{value:"Introduction",id:"introduction",level:2},{value:"Project",id:"project",level:3},{value:"Context",id:"context",level:3},{value:"Current behavior",id:"current-behavior",level:3},{value:"Implement the solution",id:"implement-the-solution",level:2},{value:"Workflow",id:"workflow",level:3},{value:"Final result",id:"final-result",level:2},{value:"Takeaway",id:"takeaway",level:2},{value:"Problems encountered",id:"problems-encountered",level:3},{value:"What did I learn ?",id:"what-did-i-learn-",level:3}],h={Highlight:m,toc:p};function d(e){let{components:t,...n}=e;return(0,s.kt)("wrapper",(0,a.Z)({},h,n,{components:t,mdxType:"MDXLayout"}),(0,s.kt)("div",{className:"pr_infos"},(0,s.kt)("div",{className:"marginBottom"},(0,s.kt)("div",null,(0,s.kt)(r.Open,{date:"22 Mar 2021",mdxType:"Open"})),(0,s.kt)("span",{className:"badge badge--secondary marginRight"},"GitHub"),(0,s.kt)("span",{className:"badge badge--secondary marginRight"},"Versioning"),(0,s.kt)("span",{className:"badge badge--secondary marginRight"},"Changelogs"),(0,s.kt)("span",{className:"badge badge--secondary marginRight"},"Monorepos"))),(0,s.kt)("admonition",{title:"Contribution link",type:"info"},(0,s.kt)("p",{parentName:"admonition"},(0,s.kt)("a",{parentName:"p",href:"https://github.com/changesets/action/pull/80"},"https://github.com/changesets/action/pull/80"))),(0,s.kt)("admonition",{title:"Contribution Type",type:"tip"},(0,s.kt)("p",{parentName:"admonition"},"This contribution is a new ",(0,s.kt)("strong",{parentName:"p"},"feature"),".")),(0,s.kt)("h2",{id:"introduction"},"Introduction"),(0,s.kt)("div",{className:"image-wrapper"},(0,s.kt)(r.ImageWrapper,{src:(0,i.Z)("img/changesets/cover.jpg"),width:"100%",alt:"Contribution presentation",mdxType:"ImageWrapper"}),(0,s.kt)("em",null,"Changesets releases")),(0,s.kt)("h3",{id:"project"},"Project"),(0,s.kt)("p",null,"You can find the ",(0,s.kt)("strong",{parentName:"p"},"Changesets project presentation")," ",(0,s.kt)("a",{href:"/docs/projects/changesets"},(0,s.kt)(m,{color:"#203666",mdxType:"Highlight"},"here")),"."),(0,s.kt)("h3",{id:"context"},"Context"),(0,s.kt)("p",null,"This contribution will be made to a specific part of the Changesets project, the ",(0,s.kt)("a",{href:"https://github.com/changesets/action"},(0,s.kt)(m,{color:"#203666",mdxType:"Highlight"},"Changesets Release Action")),".",(0,s.kt)("br",{parentName:"p"}),"\n","This action will create a release pull request with all the package versions and changelogs updated.  "),(0,s.kt)("p",null,"Here is a workflow example."),(0,s.kt)("pre",null,(0,s.kt)("code",{parentName:"pre",className:"language-yml"},"name: Release\n\non:\n  push:\n    branches:\n      - master\n\njobs:\n  release:\n    name: Release\n    runs-on: ubuntu-latest\n    steps:\n      - name: Checkout Repo\n        uses: actions/checkout@master\n        with:\n          fetch-depth: 0\n\n      - name: Setup Node.js 12.x\n        uses: actions/setup-node@master\n        with:\n          node-version: 12.x\n\n      - name: Install Dependencies\n        run: yarn\n\n      - name: Create Release Pull Request\n        uses: changesets/action@master\n        env:\n          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}\n")),(0,s.kt)("h3",{id:"current-behavior"},"Current behavior"),(0,s.kt)("a",{href:"https://github.com/semantic-release/semantic-release"},(0,s.kt)(m,{color:"#203666",mdxType:"Highlight"},"Semantic-release"))," (a tool for automating the whole package release workflow) has a feature whereby once a commit which solves an issue is released, the action comments on the associated issue and PR thread to notify the user.",(0,s.kt)("p",null,'This feature would be a "nice to have" feature for the changesets project.'),(0,s.kt)("admonition",{title:"Issue link",type:"note"},(0,s.kt)("p",{parentName:"admonition"},(0,s.kt)("a",{parentName:"p",href:"https://github.com/atlassian/changesets/issues/511"},"https://github.com/atlassian/changesets/issues/511"))),(0,s.kt)("h2",{id:"implement-the-solution"},"Implement the solution"),(0,s.kt)("admonition",{title:"code blocks",type:"caution"},(0,s.kt)("p",{parentName:"admonition"},"The code blocks are intentionally incomplete for the sake of readability.",(0,s.kt)("br",{parentName:"p"}),"\n","If you want to read the full code you'll find it in the PR link at the top.")),(0,s.kt)("admonition",{title:"changes",type:"warning"},(0,s.kt)("p",{parentName:"admonition"},"This PR being still Open, some parts are likely to change.",(0,s.kt)("br",{parentName:"p"}),"\n","I will keep the article updated if any changes are made.")),(0,s.kt)("p",null,"Here is the main logic to comment on PRs and issues that have been released.",(0,s.kt)("br",{parentName:"p"}),"\n","The boolean variable ",(0,s.kt)("inlineCode",{parentName:"p"},"comment")," lets the User activate or not the feature via an input property."),(0,s.kt)("p",null,"The comment logic is triggered once a whole repo release is published."),(0,s.kt)("div",{className:"image-wrapper"},(0,s.kt)(r.ImageWrapper,{src:(0,i.Z)("img/changesets/workflow.png"),width:"80%",alt:"Workflow",mdxType:"ImageWrapper"})),(0,s.kt)("h3",{id:"workflow"},"Workflow"),(0,s.kt)("p",null,"Here is the different steps of the workflow with their associated code blocks."),(0,s.kt)("p",null,(0,s.kt)("strong",{parentName:"p"},"NOTE:")," We are using the ",(0,s.kt)("a",{href:"https://octokit.github.io/rest.js/v18"},(0,s.kt)(m,{color:"#203666",mdxType:"Highlight"},"octokit"))," GitHub REST API client for JavaScript. This is an official client for interacting with the GitHub API."),(0,s.kt)("ol",null,(0,s.kt)("li",{parentName:"ol"},"Retrieve the tag associated with the release"),(0,s.kt)("li",{parentName:"ol"},"Take the commit sha associated with the tag")),(0,s.kt)("pre",null,(0,s.kt)("code",{parentName:"pre",className:"language-ts"},'const repo = github.context.repo;\n\nlet tagPage = 0;\nlet tagFound = false;\nlet tagCommitSha = "";\n\n/* 1 */\nwhile (!tagFound) {\n  await octokit.repos\n    .listTags({\n      ...repo,\n      per_page: 100,\n      page: tagPage,\n    })\n    .then(({ data }) => {\n      const tag = data.find((el) => el.name === tagName);\n      if (tag) {\n        tagFound = true;\n        /* 2 */\n        tagCommitSha = tag.commit.sha;\n      }\n      tagPage += 1;\n    })\n    .catch((err) => console.warn(err));\n}\n')),(0,s.kt)("ol",{start:3},(0,s.kt)("li",{parentName:"ol"},"Retrieve all the commits starting from the tag commit sha")),(0,s.kt)("pre",null,(0,s.kt)("code",{parentName:"pre",className:"language-ts"},"/* 3 */\nconst commits = await octokit.repos\n  .listCommits({\n    ...repo,\n    sha: tagCommitSha,\n  })\n  .then(({ data }) => data);\n\nconst shas = commits.map(({ sha }) => sha);\n\nconst searchQueries = getSearchQueries(\n  `repo:${repo.owner}/${repo.repo}+type:pr+is:merged`,\n  shas\n).map(\n  async (q) =>\n    (await octokit.search.issuesAndPullRequests({ q })).data.items\n);\n\nconst queries = await (await Promise.all(searchQueries)).flat();\n\nconst queriesSet = queries.map((el) => el.number);\n\nconst filteredQueries = queries.filter(\n  (el, i) => queriesSet.indexOf(el.number) === i\n  );\n")),(0,s.kt)("p",null,"Here is the ",(0,s.kt)("inlineCode",{parentName:"p"},"getSearchQueries")," helper:"),(0,s.kt)("ul",null,(0,s.kt)("li",{parentName:"ul"},(0,s.kt)("strong",{parentName:"li"},"Definition:")," Build a search query to retrieve pulls with commit hashes.   "),(0,s.kt)("li",{parentName:"ul"},(0,s.kt)("strong",{parentName:"li"},"Example:")," ",(0,s.kt)("inlineCode",{parentName:"li"},"repo:<OWNER>/<REPO>+type:pr+is:merged+hash:<FIRST_COMMIT_HASH>+hash:<SECOND_COMMIT_HASH>..."))),(0,s.kt)("pre",null,(0,s.kt)("code",{parentName:"pre",className:"language-ts"},"const getSearchQueries = (base: string, commits: string[]) => {\n  return commits.reduce((searches, commit) => {\n    const lastSearch = searches[searches.length - 1];\n\n    if (lastSearch && lastSearch.length + commit.length <= 256 - 6) {\n      searches[searches.length - 1] = `${lastSearch}+hash:${commit}`;\n    } else {\n      searches.push(`${base}+hash:${commit}`);\n    }\n\n    return searches;\n  }, [] as string[]);\n};\n")),(0,s.kt)("ol",{start:4},(0,s.kt)("li",{parentName:"ol"},"Retrieve the PRs with commits sha matching the release commits")),(0,s.kt)("pre",null,(0,s.kt)("code",{parentName:"pre",className:"language-ts"},"/* 4 */\nconst pulls = await filteredQueries.filter(\n  async ({ number }) =>\n    (\n      await octokit.pulls.listCommits({\n        owner: repo.owner,\n        repo: repo.repo,\n        pull_number: number,\n      })\n    ).data.find(({ sha }) => shas.includes(sha)) ||\n    shas.includes(\n      (\n        await octokit.pulls.get({\n          owner: repo.owner,\n          repo: repo.repo,\n          pull_number: number,\n        })\n      ).data.merge_commit_sha\n    )\n);\n")),(0,s.kt)("ol",{start:5},(0,s.kt)("li",{parentName:"ol"},"Map through the list of commits and the list of PRs to find commit message or PRs body that closes an issue and get the issue number.   ")),(0,s.kt)("p",null,"We will be using a library called ",(0,s.kt)("a",{href:"https://github.com/pvdlg/issue-parser"},(0,s.kt)(m,{color:"#203666",mdxType:"Highlight"},"issue-parser"))," which will parse the content of the Pull Request body and find ",(0,s.kt)("a",{href:"https://docs.github.com/en/github/managing-your-work-on-github/linking-a-pull-request-to-an-issue"},(0,s.kt)(m,{color:"#203666",mdxType:"Highlight"},"closing keywords"))," like ",(0,s.kt)("inlineCode",{parentName:"p"},"Fix #25"),"."),(0,s.kt)("p",null,"For example, given the PR body content ",(0,s.kt)("inlineCode",{parentName:"p"},'"Issue description, Fix #25"')," it will give the following output:"),(0,s.kt)("pre",null,(0,s.kt)("code",{parentName:"pre",className:"language-json"},'{\n    "actions": {\n        "close": [\n            {\n                "raw": "Fix #25",\n                "action": "Fix",\n                "prefix": "#",\n                "issue": "25"\n            }\n        ],\n        "duplicate": []\n    },\n    "refs": [],\n    "mentions": []\n}\n')),(0,s.kt)("p",null,"We can then retrieve the referenced issue numbers with: ",(0,s.kt)("inlineCode",{parentName:"p"},"actions.close.map({issue}) => issue)")),(0,s.kt)("pre",null,(0,s.kt)("code",{parentName:"pre",className:"language-ts"},"/* 5 */\nimport issueParser from 'issue-parser';\nconst parse = issueParser('github');\n\nconst issues = [\n  ...pulls.map((pr) => pr.body),\n  ...commits.map(({ commit }) => commit.message),\n].reduce((issues, message) => {\n  return message\n    ? issues.concat(\n        parser(message)\n          .actions.close.filter(\n            (action) =>\n              action.slug === null ||\n              action.slug === undefined ||\n              action.slug === `${repo.owner}/${repo.repo}`\n          )\n          .map((action) => ({ number: Number.parseInt(action.issue, 10) }))\n      )\n    : issues;\n}, [] as { number: number }[]);\n")),(0,s.kt)("ol",{start:6},(0,s.kt)("li",{parentName:"ol"},"Create a comment for each issue and PR")),(0,s.kt)("pre",null,(0,s.kt)("code",{parentName:"pre",className:"language-ts"},"/* 6 */\nawait Promise.all(\n  [...new Set([...pulls, ...issues].map(({ number }) => number))].map(\n    async (number) => {\n      const issueComment = {\n        ...repo,\n        issue_number: number,\n        body: getReleaseMessage(htmlUrl, tagName),\n      };\n      octokit.issues.createComment(issueComment);\n    }\n  )\n);\n")),(0,s.kt)("h2",{id:"final-result"},"Final result"),(0,s.kt)("p",null,"Every time a release is made, a comment will be made to PRs and issues that have been released.   "),(0,s.kt)("p",null,"I also created a ",(0,s.kt)("a",{href:"https://codesandbox.io/s/winter-bird-pwn6v?file=/src/index.js"},(0,s.kt)(m,{color:"#203666",mdxType:"Highlight"},"codesandbox project"))," where you can see the logic to get the issues and pull-requests associated to a release more easily. You can use your own GitHub token to increase the API rate limit."),(0,s.kt)("p",null,(0,s.kt)("strong",{parentName:"p"},"NOTE:")," In codesandbox, considering that the code does not run at the time the release is created, we will get more recent commits. This will not happen in the real world."),(0,s.kt)("h2",{id:"takeaway"},"Takeaway"),(0,s.kt)("h3",{id:"problems-encountered"},"Problems encountered"),(0,s.kt)("p",null,"Setting up the environment locally as well as testing the behavior of the developed functionality was a bit complicated because there was a strong dependency with GitHub.",(0,s.kt)("br",{parentName:"p"}),"\n","(e.g. Some scenarios to reproduce as creating a release...)"),(0,s.kt)("h3",{id:"what-did-i-learn-"},"What did I learn ?"),(0,s.kt)("p",null,"This contribution allowed me to learn more about ",(0,s.kt)("strong",{parentName:"p"},"package release workflow")," and ",(0,s.kt)("strong",{parentName:"p"},"GitHub Actions"),"."))}d.isMDXComponent=!0},6395:function(e,t,n){n.r(t),n.d(t,{ImageWrapper:function(){return h},Merged:function(){return p},Open:function(){return d},Status:function(){return g},assets:function(){return c},contentTitle:function(){return l},default:function(){return f},frontMatter:function(){return o},metadata:function(){return u},toc:function(){return m}});var a=n(3117),s=n(7294),i=n(3905),r=n(2879);const o={},l=void 0,u={unversionedId:"utils",id:"utils",title:"utils",description:"",source:"@site/docs/utils.md",sourceDirName:".",slug:"/utils",permalink:"/docs/utils",draft:!1,editUrl:"https://github.com/ayshiff/my-open-source-journey/docs/utils.md",tags:[],version:"current",frontMatter:{}},c={},m=[],p=e=>{let{date:t}=e;return(0,i.kt)("div",null,(0,i.kt)("div",{className:"merged"},(0,i.kt)("span",null,(0,i.kt)("svg",{height:"16",viewBox:"0 0 16 16",version:"1.1",width:"16",fill:"white","aria-hidden":"true",className:"status_svg"},(0,i.kt)("path",{fillRule:"evenodd",d:"M5 3.254V3.25v.005a.75.75 0 110-.005v.004zm.45 1.9a2.25 2.25 0 10-1.95.218v5.256a2.25 2.25 0 101.5 0V7.123A5.735 5.735 0 009.25 9h1.378a2.251 2.251 0 100-1.5H9.25a4.25 4.25 0 01-3.8-2.346zM12.75 9a.75.75 0 100-1.5.75.75 0 000 1.5zm-8.5 4.5a.75.75 0 100-1.5.75.75 0 000 1.5z"})),"Merged")),t||null)},h=e=>{let{src:t,alt:n,width:a}=e;const[o,l]=s.useState(!1);return(0,i.kt)("div",null,(0,i.kt)("div",{className:"image-zoom",onClick:()=>l(!0)},(0,i.kt)("img",{src:t,alt:n,width:a})),o&&(0,i.kt)(r.Z,{mainSrc:t,onCloseRequest:()=>l(!1),mdxType:"Lightbox"}))},d=e=>{let{date:t}=e;return(0,i.kt)("div",null,(0,i.kt)("div",{className:"open"},(0,i.kt)("span",null,(0,i.kt)("svg",{height:"16",viewBox:"0 0 16 16",version:"1.1",width:"16",fill:"white","aria-hidden":"true",className:"status_svg"},(0,i.kt)("path",{fillRule:"evenodd",d:"M7.177 3.073L9.573.677A.25.25 0 0110 .854v4.792a.25.25 0 01-.427.177L7.177 3.427a.25.25 0 010-.354zM3.75 2.5a.75.75 0 100 1.5.75.75 0 000-1.5zm-2.25.75a2.25 2.25 0 113 2.122v5.256a2.251 2.251 0 11-1.5 0V5.372A2.25 2.25 0 011.5 3.25zM11 2.5h-1V4h1a1 1 0 011 1v5.628a2.251 2.251 0 101.5 0V5A2.5 2.5 0 0011 2.5zm1 10.25a.75.75 0 111.5 0 .75.75 0 01-1.5 0zM3.75 12a.75.75 0 100 1.5.75.75 0 000-1.5z"})),"Open")),t||null)},g=e=>{let{url:t}=e;const[n,a]=s.useState(null);return s.useEffect((()=>{let e=!0;return fetch(t).then((e=>e.json())).then((t=>{e&&a(t.merged)})),()=>{e=!1}}),[]),null===n?(0,i.kt)("div",null):!0===n?(0,i.kt)(p,{mdxType:"Merged"}):(0,i.kt)(d,{mdxType:"Open"})},k={toc:m,Merged:p,ImageWrapper:h,Open:d,Status:g};function f(e){let{components:t,...n}=e;return(0,i.kt)("wrapper",(0,a.Z)({},k,n,{components:t,mdxType:"MDXLayout"}))}f.isMDXComponent=!0}}]);